document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const questionSelect = document.getElementById('question-select');
    const manualInput = document.getElementById('manual-input');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const operatorBtn = document.getElementById('operator-btn');
    const statusElement = document.getElementById('status');
    
    let operatorConnected = false;
    let chatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
    const TELEGRAM_BOT_TOKEN = '7903288630:AAHnmJSsZl4CEzPHUGvSx1itd0zQsiQ0_G4';
    const TELEGRAM_CHAT_ID = '1410525210';
    let lastCheckTime = 0;
    
    // ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð±Ð¾Ñ‚Ð°
    addBotMessage('Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð¯ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° Ð¸Ð»Ð¸ Ð¿Ð¾Ð·Ð¾Ð²Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°, ÐµÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°.');
    
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°
    questionSelect.addEventListener('change', function() {
        if (this.value === '') return;
        
        if (this.value === 'other') {
            manualInput.style.display = 'block';
            questionSelect.style.display = 'none';
            return;
        }
        
        const questionText = this.options[this.selectedIndex].text;
        addUserMessage(questionText);
        
        // ÐžÑ‚Ð²ÐµÑ‚Ñ‹ Ð±Ð¾Ñ‚Ð° Ð½Ð° Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
        switch(this.value) {
            case 'delivery':
                setTimeout(() => {
                    addBotMessage('Ð¡Ñ€Ð¾Ðº Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð’ ÑÑ€ÐµÐ´Ð½ÐµÐ¼ 2-5 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹.');
                }, 1000);
                break;
            case 'payment':
                setTimeout(() => {
                    addBotMessage('ÐœÑ‹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸, Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ðµ ÐºÐ°Ñ€Ñ‚Ñ‹, Apple Pay, Google Pay Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð¡Ð‘ÐŸ.');
                }, 1000);
                break;
            case 'return':
                setTimeout(() => {
                    addBotMessage('Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 14 Ð´Ð½ÐµÐ¹ Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ. Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐµ Ð¸ Ð±ÐµÐ· ÑÐ»ÐµÐ´Ð¾Ð² Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ.');
                }, 1000);
                break;
            case 'contact':
                setTimeout(() => {
                    addBotMessage('ÐÐ°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹:\nÐ¢ÐµÐ»ÐµÑ„Ð¾Ð½: +7 (123) 456-78-90\nEmail: support@example.com\nÐÐ´Ñ€ÐµÑ: Ð³. ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð°Ñ, Ð´. 1');
                }, 1000);
                break;
        }
        
        this.value = '';
    });
    
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    sendBtn.addEventListener('click', function() {
        const message = userInput.value.trim();
        if (message) {
            addUserMessage(message);
            userInput.value = '';
            
            if (!operatorConnected) {
                setTimeout(() => {
                    addBotMessage('Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ñ Ð½Ðµ Ð¼Ð¾Ð³Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° ÑÑ‚Ð¾Ñ‚ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð·Ð¾Ð²Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°.');
                }, 1000);
            } else {
                // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ
                sendMessageToOperator(message);
            }
        }
    });
    
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð²Ñ‹Ð·Ð¾Ð²Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
    operatorBtn.addEventListener('click', function() {
        if (operatorConnected) {
            addBotMessage('ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑƒÐ¶Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ Ðº Ñ‡Ð°Ñ‚Ñƒ.');
            return;
        }
        
        addUserMessage('ÐŸÐ¾Ð·Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°');
        addBotMessage('ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½ Ð¾ Ð²Ð°ÑˆÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ...');
        
        // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð² Telegram
        const message = `ðŸ”” ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ!\nID Ñ‡Ð°Ñ‚Ð°: ${chatId}\nÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ.`;
        
        const keyboard = {
            inline_keyboard: [[
                {
                    text: 'âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº Ñ‡Ð°Ñ‚Ñƒ',
                    callback_data: `connect_${chatId}`
                }
            ]]
        };
        
        sendTelegramMessageWithKeyboard(message, keyboard)
            .then(() => {
                // ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
                startPollingOperatorMessages();
            })
            .catch(error => {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
                addBotMessage('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
            });
    });
    
    // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    function addBotMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'bot-message');
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'user-message');
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function addOperatorMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'operator-message');
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð¾Ð¹
    function sendTelegramMessageWithKeyboard(text, keyboard) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const params = {
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            reply_markup: JSON.stringify(keyboard)
        };
        
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
        });
    }
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ
    function sendMessageToOperator(text) {
        const message = `ðŸ’¬ [Ð§Ð°Ñ‚ ${chatId}]: ${text}`;
        sendTelegramMessage(message);
    }
    
    // Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð² Telegram
    function sendTelegramMessage(text) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const params = {
            chat_id: TELEGRAM_CHAT_ID,
            text: text
        };
        
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
        });
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° (Ð±ÐµÐ· Ð‘Ð”)
    function startPollingOperatorMessages() {
        const polling = setInterval(() => {
            fetch(`operator_messages.php?chat_id=${chatId}&last_check=${lastCheckTime}`)
                .then(response => response.json())
                .then(data => {
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            addOperatorMessage(msg.text);
                            
                            if (!operatorConnected) {
                                operatorConnected = true;
                                statusElement.textContent = 'ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¾Ð½Ð»Ð°Ð¹Ð½';
                                addBotMessage('ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ Ðº Ñ‡Ð°Ñ‚Ñƒ. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ð±Ñ‰Ð°Ñ‚ÑŒÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ.');
                            }
                        });
                        lastCheckTime = data.last_check;
                    }
                    
                    // Ð•ÑÐ»Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚
                    if (!operatorConnected && Date.now() - startTime > 300000) {
                        clearInterval(polling);
                        addBotMessage('ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð». ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
                    }
                })
                .catch(error => console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð¿Ñ€Ð¾ÑÐ°:', error));
        }, 2000);
        
        const startTime = Date.now();
        
        // ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
        window.addEventListener('beforeunload', () => clearInterval(polling));
    }
});
